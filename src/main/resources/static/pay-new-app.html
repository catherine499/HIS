<!doctype html>
<html class="no-js" lang="zxx">

<head>
    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="Site keywords here">
    <meta name="description" content="">
    <meta name='copyright' content=''>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Title -->
    <title></title>

    <!-- Favicon -->
    <link rel="icon" href="img/favicon.png">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Nice Select CSS -->
    <link rel="stylesheet" href="css/nice-select.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <!-- icofont CSS -->
    <link rel="stylesheet" href="css/icofont.css">
    <!-- Slicknav -->
    <link rel="stylesheet" href="css/slicknav.min.css">
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="css/owl-carousel.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="css/datepicker.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="css/animate.min.css">
    <!-- Magnific Popup CSS -->
    <link rel="stylesheet" href="css/magnific-popup.css">

    <!-- Medipro CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Color CSS -->
    <link rel="stylesheet" href="css/color/color1.css">
    <!--<link rel="stylesheet" href="css/color/color2.css">-->
    <!--<link rel="stylesheet" href="css/color/color3.css">-->
    <!--<link rel="stylesheet" href="css/color/color4.css">-->
    <!--<link rel="stylesheet" href="css/color/color5.css">-->
    <!--<link rel="stylesheet" href="css/color/color6.css">-->
    <!--<link rel="stylesheet" href="css/color/color7.css">-->
    <!--<link rel="stylesheet" href="css/color/color8.css">-->
    <!--<link rel="stylesheet" href="css/color/color9.css">-->
    <!--<link rel="stylesheet" href="css/color/color10.css">-->
    <!--<link rel="stylesheet" href="css/color/color11.css">-->
    <!--<link rel="stylesheet" href="css/color/color12.css">-->

    <link rel="stylesheet" href="#" id="colors">


</head>

<body>
    <!-- Header Area -->
    <header class="header style2">
        <div class="header-inner">
            <div class="container">
                <div class="inner">
                    <div class="row">
                        <div class="col-12">
                            <!-- Main Menu -->
                            <div class="main-menu" style="float: left;">
                                <nav class="navigation">
                                    <ul class="nav menu">
                                        <li><a href="pay-main.html">收费</a></li>
                                        <li class="active"><a href="pay-new-app.html">现场挂号</a></li>
                                        <li><a href="pay-app.html">预约取号</a></li>
                                        <li><a href="pay-history.html">缴费单记录</a></li>
                                        <li><a href="pay-refund.html">退费</a></li>
                                    </ul>
                                </nav>
                            </div>
                            <div class="get-quote" style="float: right; margin-top: 10px;">
                                <a href="staff-login.html" class="btn">退出</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/ End Header Inner -->
    </header>
    <!-- End Header Area -->

    <!-- Start portfolio -->
    <section class="portfolio section" style="padding-top: 20px; height: 90%; width: 100%; ">
        <div class="row" id="option-filter" style="display: flex;">
            <div class="col-lg-4 col-md-6 col-12">
                <div class="form-group">
                    <div class="nice-select form-control wide" tabindex="0"><span class="current"
                            id="selected-dept">所有科室</span>
                        <ul class="list">
                            <li data-value="0" class="option selected ">所有科室</li>
                            <li data-value="1" class="option">内科</li>
                            <li data-value="2" class="option">外科</li>
                            <li data-value="3" class="option">儿科</li>
                            <li data-value="4" class="option">五官科</li>
                            <li data-value="5" class="option">皮肤科</li>
                            <li data-value="6" class="option">康复科</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-12">
                <div class="form-group">
                    <div class="nice-select form-control wide" tabindex="0"><span class="current"
                            id="selected-type">普通号</span>
                        <ul class="list">
                            <li data-value="0" class="option selected ">普通号</li>
                            <li data-value="1" class="option">专家号</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-12">
                <button class="btn" style="float: right; width: 100%; margin-bottom: 20px;"
                    onclick="filter()">筛选</button>
            </div>

            <div id="available-list-doc" style="display: none;">
                <table class="table new-app-table">
                    <colgroup>
                        <col style="width: 20%;" />
                        <col style="width: 30%;" />
                        <col style="width: 30%;" />
                        <col style="width: 20%;" />
                    </colgroup>
                    <thead>
                        <tr>
                            <th>科室</th>
                            <th>专家姓名</th>
                            <th>剩余号数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="doctor-list">
                        <tr>
                            <td>外科</td>
                            <td>啊啊啊</td>
                            <td>4</td>
                            <td>
                                <button class="btn pay-app-list-btn">挂号</button>
                            </td>
                        </tr>
                        <tr>
                            <td>外科</td>
                            <td>突突突</td>
                            <td>2</td>
                            <td>
                                <button class="btn pay-app-list-btn">挂号</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="available-list-dept" style="display:block;">
                <table class="table new-app-table">
                    <colgroup>
                        <col style="width: 40%;" />
                        <col style="width: 40%;" />
                        <col style="width: 20%;" />
                    </colgroup>
                    <thead>
                        <tr>
                            <th>科室</th>
                            <th>已预约人数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="dept-list">
<!--                        <tr>-->
<!--                            <td>外科</td>-->
<!--                            <td>3</td>-->
<!--                            <td>-->
<!--                                <button class="btn pay-app-list-btn">挂号</button>-->
<!--                            </td>-->
<!--                        </tr>-->
                    </tbody>
                </table>
            </div>
        </div>

    </section>
    <!--/ End portfolio -->
    <!-- 遮罩层！ -->
    <div id="shadow" style="display: none;"></div>

    <!-- 确认挂号的子窗口 -->
    <div id="box-new-app" style="display: none;">
        <div class="container">
            <div class="main-sidebar" style="text-align: center;">
                <div class="single-widget category">
                    <h6 class="title" style="text-align: left;">请填写患者信息</h6>
                    <div style="width: 100%;">

                        <div class="patient-info-item">
                            <p class="item-p">姓名：</p>
                            <p class="item-p">身份证号：</p>
                        </div>
                        <div class="patient-info-input">
                            <p class="input-p"><input id="new-patient-name" /></p>
                            <p class="input-p"><input id="new-patient-id" /></p>
                        </div>
                    </div>


                    <div class="box-btngroup">
                        <button class="btn box-btn-confirm" onclick="confirm()">确认挂号</button>
                        <button class="btn box-btn-cancel" onclick="cancel()">取消挂号</button>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <!-- jquery Min JS -->
    <script src="js/jquery.min.js"></script>
    <!-- jquery Migrate JS -->
    <script src="js/jquery-migrate-3.0.0.js"></script>
    <!-- jquery Ui JS -->
    <script src="js/jquery-ui.min.js"></script>
    <!-- Easing JS -->
    <script src="js/easing.js"></script>
    <!-- Color JS -->
    <script src="js/colors.js"></script>
    <!-- Popper JS -->
    <script src="js/popper.min.js"></script>
    <!-- Bootstrap Datepicker JS -->
    <script src="js/bootstrap-datepicker.js"></script>
    <!-- Jquery Nav JS -->
    <script src="js/jquery.nav.js"></script>
    <!-- Slicknav JS -->
    <script src="js/slicknav.min.js"></script>
    <!-- ScrollUp JS -->
    <script src="js/jquery.scrollUp.min.js"></script>
    <!-- Niceselect JS -->
    <script src="js/niceselect.js"></script>
    <!-- Tilt Jquery JS -->
    <script src="js/tilt.jquery.min.js"></script>
    <!-- Owl Carousel JS -->
    <script src="js/owl-carousel.js"></script>
    <!-- counterup JS -->
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Steller JS -->
    <script src="js/steller.js"></script>
    <!-- Wow JS -->
    <script src="js/wow.min.js"></script>
    <!-- Magnific Popup JS -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Counter Up CDN JS -->
    <script src="js/waypoints.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Main JS -->
    <script src="js/main.js"></script>


    <style type="text/css">
        .single-widget.category {
            padding: 20px 20px;
            height: 300px;
        }

        .patient-info-item {
            float: left;
            text-align: right;
            margin-left: 20px;
            font-size: 15px;
        }


        .patient-info-input {
            float: left;
        }

        #new-patient-name,
        #new-patient-id {
            width: 300px;
            font-size: 15px;
            height: 40px;
        }

        #option-filter {
            margin-left: 30px;
            margin-right: 30px;
        }

        #available-list-doc,
        #available-list-dept {
            height: 500px;
            width: 2000px;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .new-app-table {
            width: 100%;
            color: black;
            margin-left: 20px;
            height: auto;
        }

        .item-p {
            color: black;
            font-size: 15px;
            margin-top: 30px;
        }

        .input-p {
            width: max-content;
            margin-top: 20px;
        }

        .pay-app-list-btn {
            font-size: 10px;
            width: 100px;
            padding: 5px 20px;
        }

        #shadow {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 998;
            background-color: #000;
            opacity: 0.6;
            display: none;
        }

        #box-new-app {
            width: 500px;
            height: 400px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -200px;
            margin-top: -150px;
            z-index: 999;
        }

        .box-btngroup {
            float: left;
            margin: 30px;
            margin-left: 70px;
        }

        .box-btn-confirm {
            width: 120px;
        }

        .box-btn-cancel {
            background: #2C2D3F;
            margin-left: 50px;
            width: 120px;
        }
    </style>

    <script>


        $(document).ready(function () { // department
            doctorDeptNumber = { 'DE000001': [], 'DE000002': [], 'DE000003': [], 'DE000004': [], 'DE000005': [], 'DE000006': [], }
            deptNumber = {'DE000001': 0, 'DE000002': 0, 'DE000003': 0, 'DE000004': 0, 'DE000005': 0, 'DE000006': 0}
            docNumber = {}
            doctorId2Name = {}

            regType = 0
            regDept = ''
            regDoc = ''

            hasDoc = false

            typeList = ['普通号', '专家号']
            departmentId2Name = {
                'DE000001': '内科',
                'DE000002': '外科',
                'DE000003': '儿科',
                'DE000004': '五官科',
                'DE000005': '皮肤科',
                'DE000006': '康复科',
            }
            departmentName2Id = {
                '内科': 'DE000001',
                '外科': 'DE000002',
                '儿科': 'DE000003',
                '五官科': 'DE000004',
                '皮肤科': 'DE000005',
                '康复科': 'DE000006',
            }

            $.ajax({
                type: 'get',
                dataType: 'json',
                url: '/take_number_dept',
                async: false,
                success: function (data) {
                    console.log(data)
                    // debugger

                    $('#available-list-dept').css('display','block')
                    $('#available-list-doc').css('display','none')

                    $('#dept-list').html('')
                    for (let i = 0; i < data.length; i++) {
                        deptNumber[data[i].departmentId] += data[i].number
                    }

                    for (let i = 1; i < 7; i++){
                        $('#dept-list').append(
                            '<tr>' +
                            '<td>' + departmentId2Name[data[i].departmentId] + '</td>' +
                            '<td>' + data[i].number + '</td>' +
                            '<td>' +
                            '<button class="btn pay-app-list-btn" onclick="register(this)">挂号</button>' +
                            '</td>' +
                            '</tr>'
                        )
                    }
                }
            })
        })

        function filter() {
            var filterType = typeList.indexOf($('#selected-type').text())
            regType = filterType == 1

            var filterDept = $('#selected-dept').text()

            if (filterType == 1 && !hasDoc) { // 第一次选择专家号，获取专家号的数据
                $.ajax({
                    type: 'get',
                    dataType: 'json',
                    url: '/take_number_doctor',
                    async: false,
                    success: function (data) {
                        hasDoc = true
                        for (let i = 0; i < data.length; i++) {
                            var dept = data[i].departmentId
                            console.log(dept)
                            if (doctorDeptNumber[dept].indexOf(data[i].doctorId) == -1) {
                                doctorDeptNumber[dept].push(data[i].doctorId)
                            }

                            doctorId2Name[data[i].doctorId] = data[i].doctorName

                            if (docNumber.hasOwnProperty(data[i].doctorId)) {
                                docNumber[data[i].doctorId] += data[i].number
                            } else {
                                docNumber[data[i].doctorId] = data[i].number
                            }
                        }
                    }
                })
            }

            if (filterType == 1 && filterDept == '所有科室') { // 显示所有科室专家号
                $('#available-list-dept').css('display','none')
                $('#available-list-doc').css('display','block')
                $('#doctor-list').html('')
                for (let i = 1; i < 7; i++) {
                    var currDept = doctorDeptNumber['DE00000' + i]
                    for (let j = 0; j < currDept.length; j++) {
                        var docid = currDept[j]
                        $('#doctor-list').append(
                            '<tr data-id="' + docid + '">' +
                            '<td>' + departmentId2Name['DE00000' + i] + '</td>' +
                            '<td>' + doctorId2Name[docid] + '</td>' +
                            '<td>' + docNumber[docid] + '</td>' +
                            '<td>' +
                            '<button class="btn pay-app-list-btn" onclick="register(this)">挂号</button>' +
                            '</td>' +
                            '</tr>'
                        )
                    }
                }
            } else if (filterType == 1) { // 显示选择的科室的专家号
                $('#available-list-dept').css('display','none')
                $('#available-list-doc').css('display','block')
                $('#doctor-list').html('')
                var dept = departmentName2Id[filterDept]
                var currDept = doctorDeptNumber[dept]
                for (let i = 0; i < currDept.length; i++) {
                    var docid = currDept[i]
                    $('#doctor-list').append(
                        '<tr data-id="' + docid + '">' +
                        '<td>' + filterDept + '</td>' +
                        '<td>' + doctorId2Name[docid] + '</td>' +
                        '<td>' + docNumber[docid] + '</td>' +
                        '<td>' +
                        '<button class="btn pay-app-list-btn" onclick="register(this)">挂号</button>' +
                        '</td>' +
                        '</tr>'
                    )
                }
            } else if (filterDept == '所有科室') { // 显示所有科室号
                $('#available-list-dept').css('display','block')
                $('#available-list-doc').css('display','none')
                $('#dept-list').html('')
                for (let i = 1; i < 7; i++) {
                    $('#dept-list').append(
                        '<tr>' +
                        '<td>' + departmentId2Name['DE00000' + i] + '</td>' +
                        '<td>' + deptNumber['DE00000' + i] + '</td>' +
                        '<td>' +
                        '<button class="btn pay-app-list-btn" onclick="register(this)">挂号</button>' +
                        '</td>' +
                        '</tr>'
                    )
                }
            } else {    // 显示选择的科室的号
                $('#available-list-dept').css('display','block')
                $('#available-list-doc').css('display','none')
                $('#dept-list').html('')
                $('#dept-list').append(
                    '<tr>' +
                    '<td>' + filterDept + '</td>' +
                    '<td>' + deptNumber[departmentName2Id[filterDept]] + '</td>' +
                    '<td>' +
                    '<button class="btn pay-app-list-btn" onclick="register(this)">挂号</button>' +
                    '</td>' +
                    '</tr>'
                )
            }
        }


        function register(e) {
            $('#shadow').css('display', 'block')
            $('#box-new-app').css('display', 'block')
            regDept = $(e).parent().parent().children()[0].innerHTML
            regDept=departmentName2Id[regDept]
            if (regType == 1) {
                regDoc = $(e).parent().parent().data('id')
            }
        }

        function cancel() {
            $('#shadow').css('display', 'none')
            $('#box-new-app').css('display', 'none')
        }



        function confirm() {
            // 确认, 跳转到缴费界面
            if (regType == 0) {
                var data_ = {}
                data_['patientIdentity'] = $('#new-patient-id').val()
                data_['departmentId'] = regDept
                $.ajax({
                    type: 'post',
                    dataType: 'json',
                    // contentType: 'application/json',
                    url: '/take_number_dept_submit',
                    data: data_,
                    async: true,
                    success: function(data){
                        if (data.status == "ok") {
                            registerId = data.msg
                            // registerId = '999'
                            patientId = $('#new-patient-id').val()
                            patientName = $('#new-patient-name').val()
                            var payUrl = 'pay-main.html?rid='+JSON.stringify(registerId)+
                                '&rtype=0'+
                                '&pid='+JSON.stringify(patientId)+
                                '&pname='+JSON.stringify(encodeURIComponent(patientName))

                            alert('挂号完成，点击跳转至挂号缴费')
                            location.href = payUrl
                        }
                        else{
                            alert("挂号失败！")
                        }
                    }
                })
            } else { // 专家号
                var data_ = {}
                data_['patientIdentity'] = $('#new-patient-id').val()
                data_['departmentId'] = regDept
                data_['doctorId'] = regDoc
                $.ajax({
                    type: 'post',
                    dataType: 'json',
                    // contentType: 'application/json',
                    data: data_,
                    url: '/take_number_doctor_submit',
                    success: function(data){
                        if (data.status == 'ok'){
                            console.log(data)
                            registerId = data.msg
                            // registerId = '023'
                            patientId = $('#new-patient-id').val()
                            patientName = $('#new-patient-name').val()
                            var payUrl = 'pay-main.html?rid='+JSON.stringify(registerId)+
                                '&rtype=1'+
                                '&pid='+JSON.stringify(patientId)+
                                '&pname='+JSON.stringify(encodeURIComponent(patientName))

                            alert('挂号完成，点击跳转至挂号缴费')
                            location.href = payUrl
                        } else {
                            alert(data.msg)
                        }
                    },
                })
            }
        }
        
    </script>



</body>


</html>